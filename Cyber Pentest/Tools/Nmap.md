#nmap

---

## Port Scans
---
#### Six Nmap port states
1. **Open**: indicates that a service is listening on the specified port.
2. **Closed**: indicates that no service is listening on the specified port, although the port is accessible. By accessible, we mean that it is reachable and is not blocked by a firewall or other security appliances/programs.
3. **Filtered**: means that Nmap cannot determine if the port is open or closed because the port is not accessible. This state is usually due to a firewall preventing Nmap from reaching that port. Nmap’s packets may be blocked from reaching the port; alternatively, the responses are blocked from reaching Nmap’s host.
4. **Unfiltered**: means that Nmap cannot determine if the port is open or closed, although the port is accessible. This state is encountered when using an ACK scan `-sA`.
5. **Open|Filtered**: This means that Nmap cannot determine whether the port is open or filtered.
6. **Closed|Filtered**: This means that Nmap cannot decide whether a port is closed or filtered.

#### Basic flags
`-p[range]`: scan ports in `range`
	Without `-p` flag, scan the 1000 most common ports
	`-F`: for Fast, scan the 100 most common ports
`-sT`: TCP Connect scan. The **default** scan if <u>not</u> [sudo]
`-sS`: TCP SYN scan. The **default** scan if [sudo]. <u>Stealthy</u> 
`-sU`: UDP scan. No response if open|filtered, ICMP back if closed
`-T[template]`: Set the timing template:
	paranoid (`0`), sneaky (`1`), polite (`2`), normal (`3`), aggressive (`4`), insane (`5`)
`--min|max-rate [n]` : Control the packet rate per seconds
`--min|max-parallelism [n]` : Control the number of probes used

**Verbosity, debug and reason**
`--reason`: to know why it worked (or not ?)
`-v -vv`: for verbosity
`-d -dd`: for debug

#### Advanced flags

**Scan all port**
```shell
nmap -p- [ip]
```

**Scan the versions of opened port**
```shell
nmap -p[port1,port2,...] -A -sV [ip]
```

**OS detection**
```shell
nmap -O [ip]
```

**Use default scripts**
```shell
nmap -sC [ip]
```

**Use named scripts**
```shell
nmap --script "[name]"
```
Or
```shell
nmap --script "[protocol]*"
```

**Save output**
```shell
nmap -oN [filename] #for Normal
nmap -oG [filenmae] #for grepable
```

**Scan hidden port**
```shell
sudo nmap [target] -sS -sV -Pn -n -O
```
## Advanced Port Scans
---
#### TCP Header with the 6 flags schemas
![[23540a5fcd27454892a73ac051d29664 1.png]]
#### Null, FIN and Xmas
Those scan doesn't respond if the port is open and respond with flag RST, ACK if closed
**Null scan**
<small>Scan with no flag set</small>
```shell
sudo nmap -sN [ip]
```

**FIN scan**
<small>Scan with FIN flag</small>
```shell
sudo nmap -sF [ip]
```

**Xmas scan**
<small>Scan with FIN, PSH, URG flag set</small>
```shell
sudo nmap -sX [ip]
```

#### Maimon Scan
*Obsolete*
<small>Scan with FIN, ACK flag set, respond with RST but get dropped most of the time</small>
```shell
sudo nmap -sM [ip]
```

#### ACK Scan
Used to **discover firewall rule** sets and configuration **NOT services**, it may need to be used twice
<small>Scan with ACK flag set</small>
```shell
sudo nmap -sA [ip]
```

#### Window Scan
**Similar to an ACK Scan** but may respond slightly differently
<small>Scan with ACK flag set</small>
```shell
sudo nmap -sW [ip]
```

#### Custom Scan
Choose your flags baby [ URG | ACK | PSH | RST | SYN | FIN ]
```shell
sudo nmap --scanflags URGPSHRST [ip]
```

### Spoofing and Decoy
---
**Spoof another ip**
```shell
sudo nmap -S [spoof-ip] [ip]
```

**Use decoy**
<small>ME is for my ip, RND for random ip</small>
```shell
sudo nmap -D [decoy-ip...][ME][RND] [ip]
```
Example
<small>Will send 2 decoys before my ip</small>
```shell
sudo nmap -D 10.10.20.21,10.10.20.28,ME [ip]
```

### Fragmented packets
---
Used to bypass IDS alert by sending small packets
<small>-f to divide per 2, -ff per 4</small>
```shell
sudo nmap -sS -p[port] -f [ip]
```


### Idle/Zombie Scan
---
[THM Explaination](https://tryhackme.com/r/room/nmap03#header-7)
Use a rarely-used real host to spoof (I think, go read above)
```shell
sudo nmap -sI [zombie-ip] [ip]
```

## Post Port Scan
---

## Live host discovery
---
**Some flags**
`-sL`: do a "List Scan"
`-sn`: no port scan
`-n`: no DNS queries
`-R` : query DNS server even for offline hosts
`-dns-servers [server]`: use specific DNS server

**Check the number of IPs to scan**
```shell
nmap -sL -n [ip-range]
```

**Check if hosts are online**
```shell
nmap -sn [ip-range]
```

**ARP scan**
```shell
nmap -PR -sn [ip-range]
```

**Arp-scan : Discover through another binary**
```shell
sudo arp-scan [ip-range]

sudo arp-scan -I eth0 -l [ip-range]
```

**Ping scan (ICMP echo Type 8/0)**
<small>Often blocked by windows default firewall, trigger ARP scan through</small>
```shell
nmap -PE -sn [ip-range]
```

**Timestamp scan (ICMP timestamp Type 13/14)**
```shell
nmap -PP -sn [ip-range]
```

**Mask scan (ICMP Type 17/18)**
```shell
nmap -PM -sn [ip-range]
```

**TCP SYN Ping**
```shell
nmap -PS[port-range] -sn [ip-range]
```

**TCP ACK Ping**
```shell
sudo nmap -PA[port-range] -sn [ip-range]
```

**UDP Ping**
```shell
nmap -PU -sn [ip-range]
```

**Masscan**
<small>A more aggressive alternative to nmap for host discovery</small>
```shell
masscan [ip-range] -p[port-range]
```


